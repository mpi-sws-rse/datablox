<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="Docutils 0.12: http://docutils.sourceforge.net/" />
<title>Datablox Messages</title>
<style type="text/css">

/******************************************************************************
The MIT License (MIT)

Copyright (c) 2014 Matthias Eisen

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in
all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
THE SOFTWARE.
******************************************************************************/


body {
    font-family: Palatino, "Palatino LT STD", "Palatino Linotype", "Book Antiqua", Georgia, serif;
    font-size: 16px;
    color: #111;
}

div.document {
    margin: 0 auto;
    max-width: 720px;
}


/* ========== Headings ========== */

h1, h2, h3, h4, h5, h6 {
    font-weight: normal;
    margin-top: 1.5em;
}

h1.section-subtitle, 
h2.section-subtitle, 
h3.section-subtitle,
h4.section-subtitle, 
h5.section-subtitle, 
h6.section-subtitle {
    margin-top: 0.4em;
}

h1.title {
    text-align: center;
}

h2.subtitle {
    text-align: center;
}

span.section-subtitle {
    font-size: 80%,
}

/* //-------- Headings ---------- */


/* ========== Images ========== */

img, 
.figure, 
object {
    display:        block;
    margin-left:    auto;
    margin-right:   auto;
}

div.figure {
    margin-left:    2em;
    margin-right:   2em;
}

img.align-left, .figure.align-left, object.align-left {
    clear:          left;
    float:          left;
    margin-right:   1em;
}

img.align-right, .figure.align-right, object.align-right {
    clear:          right;
    float:          right;
    margin-left:    1em;
}

img.align-center, .figure.align-center, object.align-center {
    display:        block;
    margin-left:    auto;
    margin-right:   auto;
}

/* reset inner alignment in figures */
div.align-right {
    text-align: inherit;
}

object[type="image/svg+xml"], 
object[type="application/x-shockwave-flash"] {
    overflow: hidden;
}

/* //-------- Images ---------- */



/* ========== Literal Blocks ========== */

pre, tt.literal {
    font-family: "Lucida Sans Typewriter", "Lucida Console", Monaco, "Bitstream Vera Sans Mono", monospace;
    font-size: 14px;
}

tt.literal {
    background-color: #ffa;
}

pre.address {
    margin-bottom: 0;
    margin-top: 0;
    font: inherit;
}

pre.literal-block {
    border-left: solid 5px #ccc;
    padding: 1em; 
}

pre.literal-block, pre.doctest-block, pre.math, pre.code {
}

span.interpreted {
}

span.pre {
    white-space: pre;
}

pre.code .ln { 
    color: grey; 
}
pre.code, code {
    border-style: none;
    padding: 1em 0;
}
pre.code .comment, code .comment { 
    color: #888;
}
pre.code .keyword, code .keyword {
    font-weight: bold; 
    color: #080;
}
pre.code .literal.string, code .literal.string { 
    color: #d20;
    background-color: #fff0f0;
}
pre.code .literal.number, code .literal.number { 
    color: #00d;
}
pre.code .name.builtin, code .name.builtin {
    color: #038;
    color: #820;
}
pre.code .name.namespace, code .name.namespace {
    color: #b06;
}
pre.code .deleted, code .deleted {
    background-color: #fdd;
}
pre.code .inserted, code .inserted {
    background-color: #dfd;
}


/* //-------- Literal Blocks --------- */


/* ========== Tables ========== */

table {
    border-spacing:         0;
    border-collapse:        collapse;
    border-style:           none;
    border-top:             solid 1px #111;
    border-bottom:          solid 1px #111;
}

td, 
th {
    border: none;
    padding:                0.5em;
    vertical-align:         top;
}

th {
    border-top:             solid 1px #111;
    border-bottom:          solid 1px #111;
    background-color:       #ddd;
}


table.field-list,
table.footnote,
table.citation,
table.option-list {
    border:                 none;
}
table.docinfo {
    margin:                 2em 4em;
}

table.docutils {
    margin:                 1em 0;
}

table.docutils th.field-name, 
table.docinfo th.docinfo-name {
    border:                 none;
    background:             none;
    font-weight:            bold ;
    text-align:             left ;
    white-space:            nowrap ;
    padding-left:           0;
    vertical-align:         middle; 
}

table.docutils.booktabs {
    border:                 none;
    border-top:             2px solid;
    border-bottom:          2px solid;
    border-collapse:        collapse;
}

table.docutils.booktabs * {
    border:                 0px;
}
table.docutils.booktabs th {
    border-bottom:          thin solid;
    text-align:             left;
}

span.option {
    white-space: nowrap;
}

table caption {
    margin-bottom: 2px;
}

/* //-------- Tables ---------- */


/* ========== Lists ========== */

ol.simple, ul.simple {
    margin-bottom: 1em;
}

ol.arabic {
    list-style: decimal;
}

ol.loweralpha {
    list-style: lower-alpha;
}

ol.upperalpha {
    list-style: upper-alpha;
}

ol.lowerroman {
    list-style: lower-roman;
}

ol.upperroman {
    list-style: upper-roman;
}

dl.docutils dd {
    margin-bottom: 0.5em;
}


dl.docutils dt {
    font-weight: bold;
}

/* //-------- Lists ---------- */


/* ========== Sidebar ========== */

div.sidebar {
    margin: 0 0 0.5em 1em ;
    border-left: solid 2px #111;
    padding: 1em ;
    width: 40% ;
    float: right ;
    clear: right;
}

div.sidebar {
    font-size: 14px;
}

p.sidebar-title {
    font-size: 16px;
    font-weight: bold ;
}

p.sidebar-subtitle {
    font-weight: bold;
}

/* //-------- Sidebar ---------- */


/* ========== Topic ========== */

div.topic {
    margin: 2em;
    padding: 1em 0;
    border-width: 1px;
    border-color: #111;
    border-style: solid none;
}

div.topic p {
    padding: 0;
}

p.topic-title {
    font-weight: bold;
}

/* //-------- Topic ---------- */


/* ========== Header ========== */

div.header {
    font-family:        "Century Gothic", CenturyGothic, Geneva, AppleGothic, sans-serif;
    font-size:          14px;
    margin:             2em auto 4em auto;
    max-width:          960px;
    clear:              both;
}

hr.header {
    border:             0;
    height:             1px;
    margin-top:         1em;
    background-color:   #111;
}

/* //-------- Header ---------- */


/* ========== Footer ========== */

div.footer {
    font-family:        "Century Gothic", CenturyGothic, Geneva, AppleGothic, sans-serif;
    font-size:          14px;
    margin:             6em auto 2em auto;
    max-width:          960px;
    clear:              both;
    text-align:         center;
}

hr.footer {
    border:             0;
    height:             1px;
    margin-bottom:      2em;
    background-color:   #111;
}

/* //-------- Footer ---------- */


/* ========== Admonitions ========== */

div.admonition, 
div.attention, 
div.caution, 
div.danger, 
div.error,
div.hint, 
div.important, 
div.note, 
div.tip, 
div.warning {
    margin: 2em;
    border: solid 1px #111;
    padding: 0 1em;
    background-color: #eee;
}

div.error,
div.danger {
    border-color: #a94442;
    background-color: #f2dede;
}

div.hint,
div.tip {
    border-color: #31708f;
    background-color: #d9edf7;
}

div.attention,
div.caution,
div.warning {
    border-color: #8a6d3b;
    background-color: #fcf8e3; 
}

div.hint p.admonition-title,
div.tip p.admonition-title {
    color: #31708f;
    font-weight: bold ;
}

div.note p.admonition-title,
div.admonition p.admonition-title, 
div.important p.admonition-title {
    font-weight: bold ;
}

div.attention p.admonition-title,
div.caution p.admonition-title,
div.warning p.admonition-title {
    color: #8a6d3b;
    font-weight: bold ;
}

div.danger p.admonition-title, 
div.error p.admonition-title,
.code .error {
    color: #a94442;
    font-weight: bold ;
}

/* //-------- Admonitions ---------- */


/* ========== Table of Contents ========== */

div.contents {
    margin: 2em 0;
    border: none;
}

ul.auto-toc {
    list-style-type: none;
}

a.toc-backref {
    text-decoration: none ;
    color: #111;
}

/* //-------- Table of Contents ---------- */



/* ========== Line Blocks========== */

div.line-block {
    display: block ;
    margin-top: 1em ;
    margin-bottom: 1em;
}

div.line-block div.line-block {
    margin-top: 0 ;
    margin-bottom: 0 ;
    margin-left: 1.5em;
}

/* //-------- Line Blocks---------- */


/* ========== System Messages ========== */

div.system-messages {
    margin: 5em;
}

div.system-messages h1 {
    color: red;
}

div.system-message {
    border: medium outset ;
    padding: 1em;
}

div.system-message p.system-message-title {
    color: red ;
    font-weight: bold;
}

/* //-------- System Messages---------- */


/* ========== Helpers ========== */

.hidden {
    display: none;
}

.align-left {
    text-align: left;
}

.align-center {
    clear: both ;
    text-align: center;
}

.align-right {
    text-align: right;
}

/* //-------- Helpers---------- */


p.caption {
    font-style: italic;
    text-align: center;
}

p.credits {
font-style: italic ;
font-size: smaller }

p.label {
white-space: nowrap }

p.rubric {
font-weight: bold ;
font-size: larger ;
color: maroon ;
text-align: center }

p.attribution {
text-align: right ;
margin-left: 50% }

blockquote.epigraph {
    margin: 2em 5em;
}

div.abstract {
margin: 2em 5em }

div.abstract {
font-weight: bold ;
text-align: center }

div.dedication {
margin: 2em 5em ;
text-align: center ;
font-style: italic }

div.dedication {
font-weight: bold ;
font-style: normal }


span.classifier {
font-style: oblique }

span.classifier-delimiter {
font-weight: bold }

span.problematic {
color: red }




</style>
</head>
<body>
<div class="document" id="datablox-messages">
<h1 class="title">Datablox Messages</h1>

<p>This document attempts to document the key message interactions
in datablox. It is recommended that you first read the summary
documents to understand the architecture and the key processes.</p>
<div class="section" id="process-recap">
<h1>Process Recap</h1>
<p>We will first recap the main processes in Datablox.</p>
<dl class="docutils">
<dt>Master</dt>
<dd>There is one master process. This process reads the topology file,
coordinates the startup with the caretakers and blocks, gathers
performance data during the run, and coordinates the shutdown
(either normally or due to an error or cancel request).</dd>
<dt>Caretaker</dt>
<dd>There is one caretaker per node (including the master node). The
caretaker receives requests from the master. It starts blocks,
monitors the liveness and progress of blocks, reports performance
data back to the master, and kills blocks in the case of a
cancel from the master.</dd>
<dt>Block</dt>
<dd>Blocks are the components of the actual workflow. Each block is a
separate Python process. When requested by the master, the caretaker
writes the block's configuration to a file and then fork/execs the
process. Blocks then communicate directly with the other blocks
in the workflow.</dd>
</dl>
</div>
<div class="section" id="startup-messages">
<h1>Startup Messages</h1>
<p>The master first reads the topology file and then (sequentially) starts
each block in the toplogy. The message sequence chart below shows the
sequence of messages:</p>
<div class="figure">
<object data="block_initialization.svg" type="image/svg+xml">
block_initialization.svg</object>
</div>
<p>The master first connects to the caretaker for the node associated with
the block to be started. <a class="footnote-reference" href="#id3" id="id1">[1]</a> It then sends an <tt class="docutils literal">ADD BLOCK</tt> message with
the configuration for the block. This configuration includes the
parameters specified in the topology file as well as the network
addresses of the input and output ports. TCP/IP ports are pre-assigned
by the master. It starts at a specified port number and then increments
for each port needed on the given node.</p>
<p>The caretaker writes this configuration to a file and then fork/execs
the block's process, passing it the path to the configuration file and
the path to the poll data file as command line arguments. The block
reads this configuration, stores it in its object, and then starts
listening on its input ports. It has a special input port for direct
communications from the master.</p>
<p>After forking off the block process, the caretaker returns <tt class="docutils literal">True</tt> to
indicate sucess and <tt class="docutils literal">False</tt> otherwise.</p>
<p>The master then connects to the block's master port <a class="footnote-reference" href="#id4" id="id2">[2]</a>, sends
a &quot;sync&quot; message, and waits for an (empty) response. If no response is
received by the timeout, an error is signaled, and the entire startup processes
aborted.</p>
<p>Once all the blocks have been started successfully, the master enters its
main execution loop.</p>
<table class="docutils footnote" frame="void" id="id3" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>The caretaker process is started at the beginning of the run
by the Engage infrastructure.</td></tr>
</tbody>
</table>
<table class="docutils footnote" frame="void" id="id4" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id2">[2]</a></td><td>Note that this is a ZeroMQ connect, not a TCP/IP connect. ZeroMQ
connects are lazy and sends may not be immediate. In this case,
the send will not occur until the block has actually started
listening on its receive socket. See the ZeroMQ documentation for
details.</td></tr>
</tbody>
</table>
</div>
<div class="section" id="polling-messages">
<h1>Polling Messages</h1>
<p>During the run of a job, the master polls each of the caretaker nodes
at a set interval (once every 30 seconds by default). Here is an example
of the message exchange:</p>
<object data="poll_all_nodes.svg" type="image/svg+xml">
poll_all_nodes.svg</object>
<p>The master communicates with each caretaker in turn. It sends a <tt class="docutils literal">POLL</tt>
message. This message has a single parameter: <tt class="docutils literal">get_stats</tt>, a boolean.
If <tt class="docutils literal">True</tt>, the caretaker should include system statistics.
This is requested once every 5 requests (so, 2 1/2 minutes by default).</p>
<p>The caretaker calls <tt class="docutils literal">collect_poll_data()</tt> (see below) to gather the
data. It then responds to the master with a tuple consisting of the hostname,
load data from all of the workers on the node,
node-wide system statistics (CPU and memory usage, if requested),
and any fatal errors (including the full error message
and stack trace).</p>
<p>The load data is managed by the class <tt class="docutils literal">LoadBasedResourceManager</tt>. It uses
an instance of <tt class="docutils literal">BlockPerfStates</tt> for each block to track requests made
to the block, requests served by this block, and total processing time.
These are used to compute load percentage and queue size.</p>
</div>
<div class="section" id="collect-poll-data">
<h1>collect_poll_data</h1>
<p>The message sequence chart below shows how the collection of load and
liveness data works at the worker nodes:</p>
<object data="liveness_check.svg" type="image/svg+xml">
liveness_check.svg</object>
<p>Each block process periodically writes its status data to a file specified
by the caretaker. When the caretaker receives a <tt class="docutils literal">POLL</tt> request from the
master, it cycles through all the blocks on the node. For each block,
it reads the status data file and updates its information. It also
executes a <tt class="docutils literal">ps <span class="pre">-p</span></tt> command on the block's process to verify that it
is still alive. If it is dead, it marks the status as dead and also
looks for an error dump file (which is included in the response, if present).</p>
</div>
<div class="section" id="stopping-due-to-an-error">
<h1>Stopping Due to an Error</h1>
<p>If there were any fatal errors or block timeouts returned from the caretakers,
the stop procedure is initiatiated. A <tt class="docutils literal">STOP ALL</tt> message is sent in turn to
each caretaker. Here is an example message exchange with one of the
caretaker processes:</p>
<object data="stop_all.svg" type="image/svg+xml">
stop_all.svg</object>
<p>Upon receiving the <tt class="docutils literal">STOP ALL</tt> message, it sends a <tt class="docutils literal">SIGTERM</tt> signal to each
block process. It then monitors the processes to see whether they have
exited. If they have not exited within a certain number of polls, another
<tt class="docutils literal">SIGTERM</tt> is sent (e.g. block <tt class="docutils literal">b2</tt> in our example). Finally, the block
process <tt class="docutils literal">b2</tt> is killed with a <tt class="docutils literal">SIGKILL</tt> signal. The caretaker process then
responds to the master with a <tt class="docutils literal">True</tt> value message and then exits.</p>
</div>
<div class="section" id="job-completion">
<h1>Job Completion</h1>
<p>After gathering the liveness data from a poll of the caretakers, the master
checks to see whether any blocks are still running. If no blocks are running,
and we haven't seen an error, then they are all in the <tt class="docutils literal">STOPPED</tt> state (see
<tt class="docutils literal">BlockStatus</tt> in block.py. The master then sends a <tt class="docutils literal">END RUN</tt> message to each
of the caretakers. The caretaker stops the blocks (which should have no effect),
responds to the master with <tt class="docutils literal">True</tt>, and then exits.</p>
<p>After communicating with all the caretakers, the master itself prints
final summary statistics and exits.</p>
</div>
</div>
</body>
</html>
